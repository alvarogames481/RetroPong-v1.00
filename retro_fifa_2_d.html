<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Retro Fútbol 2D</title>
  <style>
    body { margin: 0; background: #222; display: flex; justify-content: center; align-items: center; height: 100vh; }
    canvas { border: 4px solid #fff; background: #005f00; image-rendering: pixelated; }
  </style>
</head>
<body>
<canvas id="game" width="512" height="320"></canvas>
<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

const FIELD_WIDTH = canvas.width;
const FIELD_HEIGHT = canvas.height;

const PLAYER_SPEED = 2;

// Jugador principal
const player = {
  x: 100,
  y: 160,
  w: 10,
  h: 20,
  color: "white",
  speed: PLAYER_SPEED,
  lastX: 100,
  lastY: 160,
  hasBall: false,
  team: 1
};

// Jugadores IA
const team1 = [player];
const team2 = [];
const teamSize = 5;

for (let i = 1; i < teamSize + 1; i++) {
  team1.push({ x: 50, y: 50 + i * 40, w: 10, h: 20, color: "white", speed: 1, team: 1 });
  team2.push({ x: 450, y: 50 + i * 40, w: 10, h: 20, color: "red", speed: 1, team: 2 });
}

// Balón
const ball = {
  x: 130,
  y: 170,
  r: 5,
  dx: 0,
  dy: 0,
  attachedTo: null,
  bounceFrame: 0
};

const keys = {};
document.addEventListener("keydown", e => keys[e.key] = true);
document.addEventListener("keyup", e => keys[e.key] = false);

function movePlayer(p) {
  p.lastX = p.x;
  p.lastY = p.y;

  if (p === player) {
    if (keys["ArrowUp"]) p.y -= p.speed;
    if (keys["ArrowDown"]) p.y += p.speed;
    if (keys["ArrowLeft"]) p.x -= p.speed;
    if (keys["ArrowRight"]) p.x += p.speed;
  }

  p.x = Math.max(0, Math.min(FIELD_WIDTH - p.w, p.x));
  p.y = Math.max(0, Math.min(FIELD_HEIGHT - p.h, p.y));
}

function moveTeam(team, attacking) {
  for (const p of team) {
    if (p === player) continue; // ya se mueve con teclas

    let targetX = attacking ? FIELD_WIDTH - 10 : 10;
    let targetY = ball.y;

    const dx = targetX - p.x;
    const dy = targetY - p.y;
    const dist = Math.sqrt(dx * dx + dy * dy);

    if (dist > 10) {
      p.x += (dx / dist) * p.speed;
      p.y += (dy / dist) * p.speed;
    }
  }
}

function checkBallPossession(players) {
  for (const p of players) {
    const px = p.x + p.w / 2;
    const py = p.y + p.h / 2;
    const dist = Math.hypot(ball.x - px, ball.y - py);
    if (dist < p.w && !ball.attachedTo) {
      ball.attachedTo = p;
      p.hasBall = true;
    }
  }
}

function updateBall() {
  if (ball.attachedTo) {
    const offset = Math.sin(ball.bounceFrame / 5) * 1;
    ball.x = ball.attachedTo.x + ball.attachedTo.w / 2;
    ball.y = ball.attachedTo.y + ball.attachedTo.h / 2 + offset;
    ball.bounceFrame++;

    if (keys[" "] || keys["x"] || keys["X"]) {
      // Buscar compañero más cercano en dirección del movimiento
      const direction = {
        x: player.x - player.lastX,
        y: player.y - player.lastY
      };
      let bestTeammate = null;
      let bestScore = -Infinity;
      for (const mate of team1) {
        if (mate === player) continue;
        const vx = mate.x - player.x;
        const vy = mate.y - player.y;
        const mag = Math.hypot(vx, vy);
        const dot = (vx * direction.x + vy * direction.y) / (mag + 1);
        if (dot > bestScore) {
          bestScore = dot;
          bestTeammate = mate;
        }
      }
      if (bestTeammate) {
        const dx = bestTeammate.x - player.x;
        const dy = bestTeammate.y - player.y;
        const dist = Math.hypot(dx, dy);
        ball.dx = dx / dist * 3;
        ball.dy = dy / dist * 3;
        ball.attachedTo.hasBall = false;
        ball.attachedTo = null;
      }
    }
  } else {
    ball.x += ball.dx;
    ball.y += ball.dy;
    ball.dx *= 0.95;
    ball.dy *= 0.95;
  }

  if (ball.x < 0 || ball.x > FIELD_WIDTH) ball.dx *= -1;
  if (ball.y < 0 || ball.y > FIELD_HEIGHT) ball.dy *= -1;
}

function drawField() {
  ctx.fillStyle = "#005f00";
  ctx.fillRect(0, 0, FIELD_WIDTH, FIELD_HEIGHT);
  ctx.strokeStyle = "white";
  ctx.beginPath();
  ctx.moveTo(FIELD_WIDTH / 2, 0);
  ctx.lineTo(FIELD_WIDTH / 2, FIELD_HEIGHT);
  ctx.stroke();
  ctx.beginPath();
  ctx.arc(FIELD_WIDTH/2, FIELD_HEIGHT/2, 30, 0, 2 * Math.PI);
  ctx.stroke();
}

function drawPlayer(p) {
  ctx.fillStyle = p.color;
  ctx.fillRect(p.x, p.y, p.w, p.h);
}

function drawBall() {
  ctx.fillStyle = "#fff700";
  ctx.beginPath();
  ctx.arc(ball.x, ball.y, ball.r, 0, 2 * Math.PI);
  ctx.fill();
}

function loop() {
  movePlayer(player);
  moveTeam(team1, ball.x < FIELD_WIDTH / 2);
  moveTeam(team2, ball.x > FIELD_WIDTH / 2);
  checkBallPossession(team1);
  updateBall();
  drawField();
  team1.forEach(drawPlayer);
  team2.forEach(drawPlayer);
  drawBall();
  requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
